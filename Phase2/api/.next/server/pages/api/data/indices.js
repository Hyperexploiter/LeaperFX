"use strict";(()=>{var e={};e.id=636,e.ids=[636],e.modules={1495:e=>{e.exports=require("ioredis")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4580:e=>{e.exports=require("node-cache")},298:e=>{e.exports=require("rate-limiter-flexible")},1467:e=>{e.exports=import("@vercel/kv")},6555:e=>{e.exports=import("uuid")},8190:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>u,default:()=>c,routeModule:()=>p});var r=s(1802),i=s(7153),n=s(6249),o=s(1037),l=e([o]);o=(l.then?(await l)():l)[0];let c=(0,n.l)(o,"default"),u=(0,n.l)(o,"config"),p=new r.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/data/indices",pathname:"/api/data/indices",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},1753:(e,t,s)=>{s.d(t,{Ju:()=>r});class a{constructor(){this.USAGE_WINDOW=864e5,this.keyUsageCache=new Map}static getInstance(){return a.instance||(a.instance=new a),a.instance}getApiKey(e){let t=this.getEnvironmentKey(e);return process.env[t]||null}hasApiKey(e){return!!this.getApiKey(e)}getEnvironmentKey(e){return({polygon:"POLYGON_API_KEY",twelvedata:"TWELVEDATA_API_KEY",coinbase:"COINBASE_API_KEY",coinbase_secret:"COINBASE_API_SECRET",coinbase_passphrase:"COINBASE_API_PASSPHRASE",openweather:"OPENWEATHER_API_KEY",fxapi:"FXAPI_KEY",alpaca:"ALPACA_API_KEY",alpaca_secret:"ALPACA_SECRET_KEY"})[e]||`${e.toUpperCase()}_API_KEY`}getAllApiKeyInfo(){return["polygon","twelvedata","coinbase","openweather","fxapi","alpaca"].map(e=>this.getApiKeyInfo(e))}getApiKeyInfo(e){let t=this.hasApiKey(e),s=this.getUsageStats(e);return{name:e,provider:e,hasKey:t,lastUsed:s.lastUsed,requestsToday:s.requestsToday,rateLimit:this.getRateLimit(e),status:this.getKeyStatus(e)}}recordUsage(e){let t=Date.now(),s=this.keyUsageCache.get(e)||{count:0,lastReset:t};t-s.lastReset>this.USAGE_WINDOW&&(s.count=0,s.lastReset=t),s.count++,this.keyUsageCache.set(e,s)}getUsageStats(e){let t=this.keyUsageCache.get(e);return{lastUsed:t?t.lastReset:void 0,requestsToday:t?t.count:0}}getRateLimit(e){return({polygon:5,twelvedata:8,coinbase:10,openweather:60,fxapi:100,alpaca:200})[e]||60}getKeyStatus(e){let t=this.hasApiKey(e);return t?"active":"inactive"}async validateApiKey(e){let t=this.getApiKey(e);if(!t)return!1;try{switch(e){case"polygon":return await this.validatePolygonKey(t);case"twelvedata":return await this.validateTwelveDataKey(t);case"coinbase":return await this.validateCoinbaseKey(t);case"openweather":return await this.validateOpenWeatherKey(t);default:return!0}}catch(t){return console.error(`[ApiKeys] Error validating ${e} key:`,t),!1}}async validatePolygonKey(e){let t=await fetch(`https://api.polygon.io/v2/aggs/ticker/AAPL/prev?adjusted=true&apiKey=${e}`,{method:"GET"});return t.ok}async validateTwelveDataKey(e){let t=await fetch(`https://api.twelvedata.com/time_series?symbol=AAPL&interval=1day&outputsize=1&apikey=${e}`,{method:"GET"}),s=await t.json();return t.ok&&!s.message?.includes("Invalid API key")}async validateCoinbaseKey(e){let t=await fetch("https://api.exchange.coinbase.com/products",{headers:{"CB-ACCESS-KEY":e}});return t.ok}async validateOpenWeatherKey(e){let t=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Toronto&appid=${e}`,{method:"GET"});return t.ok}getHeaders(e){let t=this.getApiKey(e);if(!t)return{};switch(e){case"polygon":case"twelvedata":case"openweather":return{};case"coinbase":return{"CB-ACCESS-KEY":t,"CB-ACCESS-SIGN":"","CB-ACCESS-TIMESTAMP":Date.now().toString(),"CB-ACCESS-PASSPHRASE":this.getApiKey("coinbase_passphrase")||""};default:return{Authorization:`Bearer ${t}`,"X-API-Key":t}}}buildUrlWithKey(e,t,s){let a=this.getApiKey(e);if(!a)return t;let r=new URL(t);switch(e){case"polygon":r.searchParams.set("apiKey",a);break;case"twelvedata":case"alpaca":r.searchParams.set("apikey",a);break;case"openweather":r.searchParams.set("appid",a)}return s&&Object.entries(s).forEach(([e,t])=>{r.searchParams.set(e,t)}),r.toString()}needsRotation(e){let t=this.getUsageStats(e),s=this.getRateLimit(e);return t.requestsToday>.8*s}getUsageReport(){let e={};return this.getAllApiKeyInfo().forEach(t=>{e[t.provider]={hasKey:t.hasKey,status:t.status,requestsToday:t.requestsToday,rateLimit:t.rateLimit,needsRotation:this.needsRotation(t.provider)}}),e}}let r=a.getInstance()},7234:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.d(t,{qQ:()=>l});var r=s(298),i=s(8008),n=e([i]);i=(n.then?(await n)():n)[0];class o{constructor(){this.limiters=new Map,this.isRedisAvailable=!!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN),this.initializeDefaultLimiters()}static getInstance(){return o.instance||(o.instance=new o),o.instance}initializeDefaultLimiters(){this.createLimiter("api",{windowMs:6e4,maxRequests:parseInt(process.env.RATE_LIMIT_REQUESTS||"1000")}),this.createLimiter("data",{windowMs:6e4,maxRequests:500}),this.createLimiter("config",{windowMs:6e4,maxRequests:100}),this.createLimiter("health",{windowMs:6e4,maxRequests:60}),this.createLimiter("auth",{windowMs:3e5,maxRequests:20}),this.createLimiter("ws",{windowMs:3e5,maxRequests:10}),this.createLimiter("rates",{windowMs:6e4,maxRequests:200}),this.createLimiter("market_data",{windowMs:6e4,maxRequests:1e3})}createLimiter(e,t){let s;let a={keyPrefix:`rl_${e}`,points:t.maxRequests,duration:Math.floor(t.windowMs/1e3),blockDuration:Math.floor(t.windowMs/1e3),skipSuccessfulRequests:t.skipSuccessfulRequests||!1,skipFailedRequests:t.skipFailedRequests||!1};if(this.isRedisAvailable)try{s=new r.RateLimiterRedis({...a,storeClient:this.getRedisClient()})}catch(t){console.warn(`[RateLimit] Redis unavailable for ${e}, falling back to memory:`,t),s=new r.RateLimiterMemory(a)}else s=new r.RateLimiterMemory(a);this.limiters.set(e,s)}getRedisClient(){let e=s(1495);if(process.env.KV_URL)return new e(process.env.KV_URL);if(process.env.UPSTASH_REDIS_REST_URL)return new e({host:new URL(process.env.UPSTASH_REDIS_REST_URL).hostname,port:parseInt(new URL(process.env.UPSTASH_REDIS_REST_URL).port)||6379,password:process.env.UPSTASH_REDIS_REST_TOKEN,tls:{}});throw Error("No Redis configuration found")}async checkRateLimit(e,t="api"){let s=this.limiters.get(t);if(!s)throw Error(`Rate limiter not found for category: ${t}`);let a=i.t7.getRateLimitKey(e,t);try{let e=await s.consume(a);return{limit:s.points,remaining:e.remainingPoints||0,reset:Date.now()+(e.msBeforeNext||0)}}catch(e){return{limit:s.points,remaining:0,reset:Date.now()+(e.msBeforeNext||0),retryAfter:Math.round((e.msBeforeNext||0)/1e3)}}}async applyRateLimit(e,t,s="api"){try{let a=await this.checkRateLimit(e,s);if(t.setHeader("X-RateLimit-Limit",a.limit.toString()),t.setHeader("X-RateLimit-Remaining",a.remaining.toString()),t.setHeader("X-RateLimit-Reset",a.reset.toString()),a.retryAfter)return t.setHeader("Retry-After",a.retryAfter.toString()),t.status(429).json({success:!1,error:"Rate limit exceeded",code:"RATE_LIMIT_EXCEEDED",retryAfter:a.retryAfter,timestamp:Date.now(),requestId:i.t7.generateRequestId()}),!1;return!0}catch(e){return console.error("[RateLimit] Error applying rate limit:",e),!0}}async getRateLimitStatus(e,t="api"){let s=this.limiters.get(t);if(!s)throw Error(`Rate limiter not found for category: ${t}`);let a=i.t7.getRateLimitKey(e,t);try{let e=await s.get(a);return{limit:s.points,remaining:e?e.remainingPoints:s.points,reset:Date.now()+(e?e.msBeforeNext:0)}}catch(e){return console.error("[RateLimit] Error getting status:",e),{limit:s.points,remaining:s.points,reset:Date.now()+6e4}}}async resetRateLimit(e,t="api"){let s=this.limiters.get(t);if(!s)throw Error(`Rate limiter not found for category: ${t}`);let a=i.t7.getRateLimitKey(e,t);await s.delete(a)}createCustomLimiter(e,t){this.createLimiter(e,t)}getLimiters(){return Array.from(this.limiters.keys())}middleware(e="api"){return async(t,s,a)=>{let r=await this.applyRateLimit(t,s,e);return r&&a&&a(),r}}async checkIPRateLimit(e,t){let s=i.t7.getClientIP(e),a=`ip_rl:${s}`,n=new r.RateLimiterMemory({keyPrefix:"ip_rate_limit",points:t.maxRequests,duration:Math.floor(t.windowMs/1e3),blockDuration:Math.floor(t.windowMs/1e3)});try{let e=await n.consume(a);return{limit:t.maxRequests,remaining:e.remainingPoints||0,reset:Date.now()+(e.msBeforeNext||0)}}catch(e){return{limit:t.maxRequests,remaining:0,reset:Date.now()+(e.msBeforeNext||0),retryAfter:Math.round((e.msBeforeNext||0)/1e3)}}}}let l=o.getInstance();a()}catch(e){a(e)}})},1037:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>m,default:()=>c,getIndexName:()=>p});var r=s(8008),i=s(7234),n=s(1753),o=s(936),l=e([r,i,o]);async function c(e,t){let s=r.t7.createSecurityContext(e);r.t7.setSecurityHeaders(t);let a=r.t7.getCorsHeaders(e.headers.origin);if(Object.entries(a).forEach(([e,s])=>{t.setHeader(e,s)}),"OPTIONS"===e.method){t.status(200).end();return}if("GET"!==e.method){t.status(405).json({success:!1,error:"Method not allowed",timestamp:Date.now(),requestId:s.requestId});return}try{let a=await i.qQ.applyRateLimit(e,t,"data");if(!a)return;if(!r.t7.validateApiKey(e)){t.status(401).json({success:!1,error:"Invalid or missing API key",timestamp:Date.now(),requestId:s.requestId});return}let{symbols:l,provider:c="polygon"}=r.t7.sanitizeInput(e.query);if(!l){t.status(400).json({success:!1,error:"Symbols parameter is required",timestamp:Date.now(),requestId:s.requestId});return}let p=Array.isArray(l)?l:l.split(","),d=p.filter(e=>/^[A-Z0-9.^]+$/.test(e));if(0===d.length){t.status(400).json({success:!1,error:"No valid index symbols provided",timestamp:Date.now(),requestId:s.requestId});return}let m=`indices:${c}:${d.join(",")}`,h=await o.Fs.get(m);if(h){t.status(200).json({success:!0,data:h,timestamp:Date.now(),requestId:s.requestId});return}let y=[];if("polygon"===c){let e=await u(d);y.push(...e)}else{t.status(400).json({success:!1,error:`Unsupported provider: ${c}`,timestamp:Date.now(),requestId:s.requestId});return}await o.Fs.setex(m,30,y),n.Ju.recordUsage(c),t.status(200).json({success:!0,data:y,timestamp:Date.now(),requestId:s.requestId})}catch(e){console.error("[Indices] API error:",e),t.status(500).json({success:!1,error:"Internal server error",timestamp:Date.now(),requestId:s.requestId})}}async function u(e){let t=n.Ju.getApiKey("polygon");if(!t)throw Error("Polygon API key not configured");let s=[];for(let t of e)try{let e=t.startsWith("I:")?t:`I:${t}`,a=n.Ju.buildUrlWithKey("polygon",`https://api.polygon.io/v2/aggs/ticker/${encodeURIComponent(e)}/prev`,{adjusted:"true"}),r=await fetch(a,{headers:{"User-Agent":"LeaperFX/1.0"}});if(!r.ok){console.warn(`[Indices] Polygon prev close error for ${t}:`,r.status);continue}let i=await r.json(),o=Array.isArray(i?.results)?i.results[0]:null;if(!o)continue;let l=n.Ju.buildUrlWithKey("polygon",`https://api.polygon.io/v2/snapshot/locale/us/markets/stocks/tickers/${encodeURIComponent(e)}`),c=o.c||o.close,u=Date.now();try{let e=await fetch(l,{headers:{"User-Agent":"LeaperFX/1.0"}});if(e.ok){let t=await e.json(),s=t?.results?.value||t?.results;s&&s.lastQuote?(c=s.lastQuote.price||c,u=s.lastQuote.timeframe||u):s&&s.lastTrade&&(c=s.lastTrade.price||c,u=s.lastTrade.timestamp||u)}}catch(e){console.warn(`[Indices] Error fetching snapshot for ${t}:`,e)}let p=o.c||o.close,d=c-p,m=0!==p?d/p*100:0;s.push({symbol:t.replace("I:",""),value:c,timestamp:u,change:d,changePercent:m,source:"polygon"})}catch(e){console.error(`[Indices] Error fetching ${t} from Polygon:`,e)}return s}[r,i,o]=l.then?(await l)():l;let d={SPX:"S&P 500",DJI:"Dow Jones Industrial Average",IXIC:"NASDAQ Composite",RUT:"Russell 2000",VIX:"CBOE Volatility Index",TSX:"S&P/TSX Composite",FTSE:"FTSE 100",DAX:"DAX",CAC:"CAC 40",NIKKEI:"Nikkei 225",HSI:"Hang Seng Index"};function p(e){let t=e.toUpperCase();return d[t]||e}let m={api:{responseLimit:"8mb"}};a()}catch(e){a(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[924],()=>s(8190));module.exports=a})();